import logging
from pathlib import Path

import pandas as pd

from lib.shared.target_utils import get_sbs_combinations, get_phenotype_combinations
from lib.shared.initialize_paramsearch import initialize_segment_sbs_paramsearch
from lib.shared.initialize_paramsearch import initialize_segment_phenotype_paramsearch


# Get the general configuration options
ROOT_FP = Path(config["all"]["root_fp"])

# Get paths to the sample files dfs
SBS_SAMPLES_FP = Path(config["preprocess"]["sbs_samples_fp"])
PHENOTYPE_SAMPLES_FP = Path(config["preprocess"]["phenotype_samples_fp"])

# Load sbs samples if they exist
sbs_samples_df = pd.read_csv(SBS_SAMPLES_FP, sep="\t")
if len(sbs_samples_df) > 0:
    SBS_TILES = [1, 2]  # TODO: unrestrict: range(config["preprocess"]["sbs_tiles"])
    SBS_VALID_COMBINATIONS = get_sbs_combinations(sbs_samples_df)
else:
    print("No SBS samples found!")
    SBS_TILES = []
    SBS_VALID_COMBINATIONS = []

# Load phenotype samples if they exist
phenotype_samples_df = pd.read_csv(PHENOTYPE_SAMPLES_FP, sep="\t")
if len(phenotype_samples_df) > 0:
    PHENOTYPE_TILES = [1, 2]  # TODO: unrestrict: range(config["preprocess"]["phenotype_tiles"])
    PHENOTYPE_VALID_COMBINATIONS = get_phenotype_combinations(phenotype_samples_df)
else:
    print("No phenotype samples found!")
    PHENOTYPE_TILES = []
    PHENOTYPE_VALID_COMBINATIONS = []


include: "targets/preprocess_well.smk"
include: "rules/preprocess_well.smk"


ALL_TARGETS = PREPROCESS_TARGETS_ALL

if "sbs" in config and len(SBS_SAMPLE_FPS) > 0:
    # Initialize parameter search configurations if needed
    if config["sbs_process"]["mode"] == "segment_sbs_paramsearch":
        config = initialize_segment_sbs_paramsearch(config)

    # Include target and rule files
    include: "targets/sbs_process.smk"
    include: "rules/sbs_process.smk"

    ALL_TARGETS += SBS_PROCESS_TARGETS_ALL


if "phenotype" in config and len(PHENOTYPE_SAMPLE_FPS) > 0:
    # Initialize parameter search configurations if needed
    if config["phenotype_process"]["mode"] == "segment_phenotype_paramsearch":
        config = initialize_segment_phenotype_paramsearch(config)

    # Include target and rule files
    include: "targets/phenotype_process.smk"
    include: "rules/phenotype_process.smk"

    ALL_TARGETS += PHENOTYPE_PROCESS_TARGETS_ALL


if "merge_process" in config:

    # Include target and rule files
    include: "targets/merge_process.smk"
    include: "rules/merge_process.smk"

    ALL_TARGETS += MERGE_PROCESS_TARGETS_ALL


if "aggregate_process" in config:

    # Include target and rule files
    include: "targets/aggregate_process.smk"
    include: "rules/aggregate_process.smk"

    ALL_TARGETS += AGGREGATE_PROCESS_TARGETS_ALL
    

# Define the target files for the workflow
rule all:
    input:
        ALL_TARGETS,
